name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: coursier/cache-action@v6
      - uses: VirtusLab/scala-cli-setup@main

      - run: make test

  format:
    name: Check Formatting
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - uses: coursier/cache-action@v6
      - uses: VirtusLab/scala-cli-setup@main

      - run: make format-check

  check-and-upload-native-build-mac:
    name: Check Graal Build (Mac)
    runs-on: macos-latest
    needs: test

    steps:
      - uses: actions/checkout@v3
      - uses: coursier/cache-action@v6
      - uses: VirtusLab/scala-cli-setup@main

      - run: |
          make prepare-for-graal package-mac
          chmod +x out/skan

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: skan-x86_64-apple-darwin
          path: ./out/skan
          if-no-files-found: error
          retention-days: 5

  check-native-build-linux:
    name: Check Graal Build (Linux)
    runs-on: ubuntu-latest
    needs: test

    steps:
      - uses: actions/checkout@v3
      - uses: coursier/cache-action@v6
      - uses: VirtusLab/scala-cli-setup@main

      - run: |
          make prepare-for-graal package-linux
          chmod +x out/skan

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: skan-x86_64-linux
          path: ./out/skan
          if-no-files-found: error
          retention-days: 5

  # screw windows. I have no idea and can't get this to work
  #check-native-build-windows:
  #  name: Check Graal Build (Windows)
  #  runs-on: windows-latest

  #  steps:
  #    - uses: actions/checkout@v3
  #    - uses: coursier/cache-action@v6
  #    - uses: VirtusLab/scala-cli-setup@main

  #    - run: make prepare-for-graal package-windows
  #      shell: bash
